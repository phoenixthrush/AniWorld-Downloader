<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniWorld-Downloader</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
    <div class="container">
        <h1>AniWorld-Downloader</h1>
        <p>Enter aniworld.to link below</p>
        <input type="text" id="urlInput"
            value="https://aniworld.to/anime/stream/highschool-dxd/staffel-1/episode-1"><br>
        <button type="button" id="fetchButton">Submit</button>
        <div class="output" id="output"></div>
    </div>

    <script>
        document.getElementById("fetchButton").addEventListener("click", async () => {
            const url = document.getElementById("urlInput").value;
            const output = document.getElementById("output");

            if (!url.startsWith("https://")) {
                output.textContent = "Invalid URL!";
                return;
            }

            const proxyUrl = "https://api.codetabs.com/v1/proxy/?quest=" + encodeURIComponent(url);

            let html;
            try {
                const proxyResponse = await fetch(proxyUrl);
                if (proxyResponse.ok) {
                    html = await proxyResponse.text();
                } else {
                    throw new Error("Proxy failed");
                }
            } catch (proxyError) {
                html = await fetch(url).then(response => response.text()).catch(error => {
                    output.textContent = "Failed to fetch content, even with direct request.";
                    return null;
                });
            }

            if (html) {
                extractData(html, url, output);
            }
        });
        function extractData(html, url, outputElement) {
            const doc = new DOMParser().parseFromString(html, "text/html");

            const title = doc.querySelector(".series-title h1 span")?.textContent || "Title not found";
            const slugMatch = url.match(/\/anime\/stream\/([^/]+)/);
            const slug = slugMatch ? slugMatch[1] : "Slug not found";
            const description = doc.querySelector(".seri_des")?.getAttribute("data-full-description") || "Description not found";

            const germanTitle = doc.querySelector(".episodeGermanTitle")?.textContent || "German title not found";
            const englishTitle = doc.querySelector(".episodeEnglishTitle")?.textContent || "English title not found";

            let description_shortened = description;
            const descriptionWords = description.split(' ');
            if (descriptionWords.length > 15) {
                description_shortened = descriptionWords.slice(0, 15).join(' ') + '...';
            }

            const currentElement = doc.querySelector(".currentActiveLink a");
            const episode = currentElement?.querySelector("span[itemprop='name']")?.textContent.trim().match(/\d+/)?.[0] || "Not found";
            const seasonMatch = currentElement?.href.match(/staffel-(\d+)/);
            const season = seasonMatch ? seasonMatch[1] : "Not found";

            const languageBox = doc.querySelector(".changeLanguageBox");
            let languages = "Not found";
            if (languageBox) {
                const languageMap = {
                    1: "German Dub",
                    2: "English Sub",
                    3: "German Sub"
                };
                const langKeys = [...languageBox.querySelectorAll("img[data-lang-key]")]
                    .map(img => img.getAttribute("data-lang-key"))
                    .filter(lang => lang && !isNaN(lang))
                    .map(lang => languageMap[lang] || `Unknown (${lang})`);
                if (langKeys.length) {
                    languages = langKeys.join(", ");
                }
            }

            outputElement.textContent = `
Title:          ${title}
Slug:           ${slug}
Description:    ${description_shortened}
Season:         ${season}
Episode:        ${episode}
Ger. Title:     ${germanTitle}
Eng. Title:     ${englishTitle}
Avl. Languages: ${languages}`;
        }



    </script>
</body>

</html>